name: CI

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

permissions:
  contents: read

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  backend-checks:
    name: Backend checks
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' || needs.changes.outputs.backend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Export OpenAPI
        run: python backend/scripts/export_openapi.py

  frontend-checks:
    name: Frontend checks
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' || needs.changes.outputs.frontend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install backend deps for OpenAPI export
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Install frontend deps
        working-directory: frontend
        run: npm ci
      - name: Generate API types
        working-directory: frontend
        run: npm run gen:api
      - name: Verify generated files are up to date
        run: git diff --exit-code
      - name: Build frontend
        working-directory: frontend
        run: npm run build

  docker-build:
    name: Docker build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build image
        run: |
          docker build -t arcturus:ci .
          # docker tag arcturus:ci your-registry/arcturus:ci
          # docker push your-registry/arcturus:ci
